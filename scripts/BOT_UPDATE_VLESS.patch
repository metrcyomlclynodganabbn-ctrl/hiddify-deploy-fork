# –ü–∞—Ç—á –¥–ª—è monitor_bot.py ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∏–µ VLESS URL –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

## 1. –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ (–ø–æ—Å–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤)

```python
import os
import sys
import sqlite3
import logging
import uuid
import json
from datetime import datetime, timedelta
from functools import wraps
from telebot import TeleBot, types
from dotenv import load_dotenv

# –î–û–ë–ê–í–ò–¢–¨:
try:
    import qrcode
    from io import BytesIO
    QR_CODE_AVAILABLE = True
except ImportError:
    QR_CODE_AVAILABLE = False
```

## 2. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ VLESS URL (–ø–µ—Ä–µ–¥ init_db())

```python
# ============================================================================
# VLESS URL –ì–ï–ù–ï–†–ê–¢–û–†
# ============================================================================

def generate_vless_url(user_uuid: str, server_ip: str, port: int,
                        public_key: str, sni: str = "www.apple.com",
                        flow: str = "xtls-rprx-vision", label: str = "SKRT-VPN") -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç VLESS-Reality URL –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ –∫–ª–∏–µ–Ω—Ç
    """
    base = f"vless://{user_uuid}@{server_ip}:{port}"

    params = [
        "encryption=none",
        f"flow={flow}",
        "security=reality",
        f"sni={sni}",
        "fp=chrome",
        f"pbk={public_key}",
        "type=tcp",
        "header=none"
    ]

    url = f"{base}?{'&'.join(params)}#{label}"
    return url


def generate_vless_qr(url: str):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR –∫–æ–¥ –¥–ª—è VLESS URL
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É —Å QR –∫–æ–¥–æ–º
    """
    if not QR_CODE_AVAILABLE:
        return None

    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_L,
        box_size=10,
        border=4,
    )
    qr.add_data(url)
    qr.make(fit=True)

    img = qr.make_image(fill_color="black", back_color="white")

    import tempfile
    temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=".png")
    img.save(temp_file, format='PNG')
    temp_file.close()

    return temp_file.name
```

## 3. –ó–∞–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é handle_protocol_selection

–ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É 725: `@bot.callback_query_handler(func=lambda call: call.data.startswith('protocol_'))`

–ó–∞–º–µ–Ω–∏—Ç—å –≤—Å—é —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞:

```python
@bot.callback_query_handler(func=lambda call: call.data.startswith('protocol_'))
def handle_protocol_selection(call):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞"""

    telegram_id = call.message.chat.id
    protocol = call.data.split('_')[1]

    user = get_user(telegram_id)

    if not user:
        bot.answer_callback_query(call.id, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return

    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ .env
    vps_ip = os.getenv('VPS_IP', '5.45.114.73')
    reality_public_key = os.getenv('REALITY_PUBLIC_KEY', '')
    reality_sni = os.getenv('REALITY_SNI', 'www.apple.com')
    vless_port = int(os.getenv('VLESS_PORT', '443'))

    if protocol == 'vless':
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
        user_uuid = user.get('vless_uuid') or str(uuid.uuid4())

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º VLESS URL
        vless_url = generate_vless_url(
            user_uuid=user_uuid,
            server_ip=vps_ip,
            port=vless_port,
            public_key=reality_public_key,
            sni=reality_sni,
            label=f"SKRT-VPN-{user['telegram_first_name']}"
        )

        config_name = "VLESS-Reality ‚≠ê"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π URL
        bot.send_message(
            telegram_id,
            f"üìã *{config_name}*\n\n"
            f"```\n{vless_url}\n```\n\n"
            f"üì± *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*\n"
            f"1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—ã—à–µ\n"
            f"2. –û—Ç–∫—Ä–æ–π—Ç–µ Nekobox/V2Ray\n"
            f"3. –ò–º–ø–æ—Ä—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞\n"
            f"4. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å",
            parse_mode='Markdown'
        )

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º QR –∫–æ–¥
        qr_file = generate_vless_qr(vless_url)
        if qr_file:
            try:
                with open(qr_file, 'rb') as qr:
                    bot.send_photo(
                        telegram_id,
                        qr,
                        caption="üì∑ *–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥* –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞",
                        parse_mode='Markdown'
                    )
                # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
                os.unlink(qr_file)
            except Exception as e:
                logger.error(f"QR code error: {e}")

    elif protocol == 'hysteria2':
        # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Hysteria2
        config_link = f"hysteria2://{user['hysteria2_password']}@{vps_ip}:443/?sni={reality_sni}"
        config_name = "Hysteria2 üöÄ"

        bot.send_message(
            telegram_id,
            f"üìã *{config_name}*\n\n"
            f"```\n{config_link}\n```\n\n"
            f"–ü—Ä–æ—Ç–æ–∫–æ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ",
            parse_mode='Markdown'
        )
    else:
        # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å SS-2022
        config_link = f"ss2022://{user['ss2022_password']}@{vps_ip}:8388"
        config_name = "Shadowsocks-2022 üîí"

        bot.send_message(
            telegram_id,
            f"üìã *{config_name}*\n\n"
            f"```\n{config_link}\n```\n\n"
            f"–ü—Ä–æ—Ç–æ–∫–æ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ",
            parse_mode='Markdown'
        )

    bot.answer_callback_query(call.id, "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞")
```

## 4. –û–±–Ω–æ–≤–∏—Ç—å .env —Å Reality –∫–ª—é—á–∞–º–∏

```
REALITY_PUBLIC_KEY=whqp8uteAFCE34Pdnq__-M0RlSKJYnAxcxTl7DQzhI0
REALITY_PRIVATE_KEY=GIzQluwly3dtqukxdVG1hPIU7lRLwiYHmw4x4tZomkM
REALITY_SNI=www.apple.com
VLESS_PORT=443
```

## 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

```bash
ssh root@5.45.114.73 "systemctl restart hiddify-bot"
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
1. –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ @SKRTvpnbot
2. –ù–∞–∂–∞—Ç—å "üîó –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á"
3. –í—ã–±—Ä–∞—Ç—å "VLESS-Reality ‚≠ê"
4. –î–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏:
   - –¢–µ–∫—Å—Ç–æ–≤—ã–π VLESS URL
   - QR –∫–æ–¥ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–º–ø–æ—Ä—Ç—É

5. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Nekobox –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
