# Hiddify Manager - Makefile
# Version: 2.1.1
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   make test       - –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
#   make test-cov   - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
#   make lint       - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ —Å—Ç–∏–ª—å
#   make format     - –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
#   make install    - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
#   make install-dev - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

PYTHON := python3
PIP := pip3
PYTEST := pytest
BLACK := black
FLAKE8 := flake8
MYPY := mypy

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
SRC_DIR := scripts
TESTS_DIR := tests
DATA_DIR := data
LOGS_DIR := logs
BACKUP_DIR := backups

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –¶–µ–ª–∏
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

.PHONY: all install install-dev test test-cov test-unit test-integration lint format clean help

all: install

## install: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
install:
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	$(PIP) install -r requirements.txt

## install-dev: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å development –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
install-dev:
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	$(PIP) install -r requirements.txt
	$(PIP) install -r requirements-dev.txt

## test: –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
test:
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
	$(PYTEST) $(TESTS_DIR) -v

## test-cov: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
test-cov:
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º..."
	$(PYTEST) $(TESTS_DIR) -v --cov=$(SRC_DIR) --cov-report=html --cov-report=term

## test-unit: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ unit —Ç–µ—Å—Ç—ã
test-unit:
	@echo "üß™ –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤..."
	$(PYTEST) $(TESTS_DIR) -v -m unit

## test-integration: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
test-integration:
	@echo "üß™ –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
	$(PYTEST) $(TESTS_DIR) -v -m integration

## test-fast: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –±–µ–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö
test-fast:
	@echo "üß™ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
	$(PYTEST) $(TESTS_DIR) -v -m "not slow"

## lint: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ —Å—Ç–∏–ª—å
lint:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥ —Å—Ç–∏–ª—è..."
	$(FLAKE8) $(SRC_DIR) $(TESTS_DIR)
	@echo "‚úÖ –ö–æ–¥ —Å—Ç–∏–ª—å –≤ –ø–æ—Ä—è–¥–∫–µ"

## format: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
format:
	@echo "üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞..."
	$(BLACK) $(SRC_DIR) $(TESTS_DIR)
	@echo "‚úÖ –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω"

## typecheck: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã
typecheck:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤..."
	$(MYPY) $(SRC_DIR)
	@echo "‚úÖ –¢–∏–ø—ã –≤ –ø–æ—Ä—è–¥–∫–µ"

## check: –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (lint + typecheck + test)
check: lint typecheck test
	@echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã"

## clean: –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type f -name "*.backup-*" -delete 2>/dev/null || true
	rm -rf .pytest_cache
	rm -rf htmlcov
	rm -rf .coverage
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

## init: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (—Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)
init:
	@echo "üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞..."
	mkdir -p $(DATA_DIR)
	mkdir -p $(LOGS_DIR)
	mkdir -p $(BACKUP_DIR)
	mkdir -p output
	@echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

## backup: –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –ë–î
backup:
	@echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –ë–î..."
	./scripts/backup_db.sh

## bot: –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
bot:
	@echo "ü§ñ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
	$(PYTHON) $(SRC_DIR)/monitor_bot.py

## db: –û—Ç–∫—Ä—ã—Ç—å –ë–î (—Ç—Ä–µ–±—É–µ—Ç sqlite3)
db:
	@echo "üóÑÔ∏è –û—Ç–∫—Ä—ã—Ç–∏–µ –ë–î..."
	sqlite3 $(DATA_DIR)/bot.db

## logs: –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞
logs:
	@echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
	tail -n 50 $(LOGS_DIR)/bot.log 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

## logs-follow: –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
logs-follow:
	@echo "üìã –°–ª–µ–¥–µ–Ω–∏–µ –∑–∞ –ª–æ–≥–∞–º–∏..."
	tail -f $(LOGS_DIR)/bot.log 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

## help: –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
help:
	@echo "Hiddify Manager - Makefile –∫–æ–º–∞–Ω–¥—ã"
	@echo ""
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞:"
	@echo "  make install       - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
	@echo "  make install-dev   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
	@echo "  make init          - –°–æ–∑–¥–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
	@echo ""
	@echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:"
	@echo "  make test          - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"
	@echo "  make test-cov      - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º"
	@echo "  make test-unit     - –¢–æ–ª—å–∫–æ unit —Ç–µ—Å—Ç—ã"
	@echo "  make test-fast     - –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö)"
	@echo ""
	@echo "–ö–æ–¥ —Å—Ç–∏–ª—å:"
	@echo "  make lint          - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ —Å—Ç–∏–ª—å"
	@echo "  make format        - –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥"
	@echo "  make typecheck     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã"
	@echo "  make check         - –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏"
	@echo ""
	@echo "–£—Ç–∏–ª–∏—Ç—ã:"
	@echo "  make bot           - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
	@echo "  make backup        - –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –ë–î"
	@echo "  make db            - –û—Ç–∫—Ä—ã—Ç—å –ë–î"
	@echo "  make logs          - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
	@echo "  make logs-follow   - –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏"
	@echo "  make clean         - –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo ""
	@echo "–î–ª—è —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ü–µ–ª–∏: make help-<goal>"
